<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interior Designer - Decora con IA</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel para ejecutar el código en el navegador -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Iconos de Lucide adaptados para React
        const Icon = ({ name, className }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, []);
            return <i data-lucide={name} className={className}></i>;
        };

        const apiKey = "";
        const MODEL_NAME = "gemini-2.5-flash-image-preview";

        function App() {
            const [roomFile, setRoomFile] = useState(null);
            const [roomPreview, setRoomPreview] = useState(null);
            const [furnitureFile, setFurnitureFile] = useState(null);
            const [furniturePreview, setFurniturePreview] = useState(null);
            const [prompt, setPrompt] = useState("Coloca esta estantería al fondo a la derecha del salón, integrándola perfectamente con la iluminación y sombras de la habitación.");
            const [loading, setLoading] = useState(false);
            const [resultImage, setResultImage] = useState(null);
            const [error, setError] = useState(null);

            const fileToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                });
            };

            const handleImageUpload = (e, type) => {
                const file = e.target.files[0];
                if (file) {
                    const previewUrl = URL.createObjectURL(file);
                    if (type === 'room') {
                        setRoomFile(file);
                        setRoomPreview(previewUrl);
                    } else {
                        setFurnitureFile(file);
                        setFurniturePreview(previewUrl);
                    }
                }
            };

            const generateDesign = async () => {
                if (!roomFile || !furnitureFile || !prompt) {
                    setError("Por favor, sube ambas fotos y escribe un prompt.");
                    return;
                }

                setLoading(true);
                setError(null);

                try {
                    const roomBase64 = await fileToBase64(roomFile);
                    const furnitureBase64 = await fileToBase64(furnitureFile);

                    const payload = {
                        contents: [{
                            parts: [
                                { text: `Tarea: Integración de muebles en interiores.
                                  Imagen 1: Habitación vacía.
                                  Imagen 2: Mueble a insertar.
                                  Instrucción: ${prompt}.
                                  Asegúrate de que la perspectiva, el tamaño y las sombras del mueble coincidan con el entorno de la habitación.`
                                },
                                { inlineData: { mimeType: roomFile.type, data: roomBase64 } },
                                { inlineData: { mimeType: furnitureFile.type, data: furnitureBase64 } }
                            ]
                        }],
                        generationConfig: { responseModalities: ["IMAGE"] }
                    };

                    const executeCall = async (retryCount = 0) => {
                        try {
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                }
                            );

                            if (!response.ok) throw new Error(`Error API: ${response.status}`);

                            const data = await response.json();
                            const base64Data = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                            if (base64Data) {
                                setResultImage(`data:image/png;base64,${base64Data}`);
                            } else {
                                throw new Error("No se pudo generar la imagen.");
                            }
                        } catch (err) {
                            if (retryCount < 5) {
                                await new Promise(res => setTimeout(res, Math.pow(2, retryCount) * 1000));
                                return executeCall(retryCount + 1);
                            }
                            throw err;
                        }
                    };

                    await executeCall();
                } catch (err) {
                    setError("Error al conectar con la IA. Inténtalo de nuevo.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-5xl mx-auto">
                        <header className="mb-8 text-center">
                            <div className="inline-flex items-center justify-center p-2 bg-indigo-100 rounded-full mb-4">
                                <Icon name="home" className="w-5 h-5 text-indigo-600 mr-2" />
                                <span className="text-indigo-600 font-bold uppercase tracking-wider text-[10px]">AI Interior Designer</span>
                            </div>
                            <h1 className="text-4xl font-extrabold text-slate-900 mb-2 tracking-tight">Decora con IA</h1>
                            <p className="text-slate-500">Transforma espacios vacíos en habitaciones amuebladas con un prompt.</p>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-6 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                <div>
                                    <label className="block text-sm font-semibold mb-3 flex items-center">
                                        <Icon name="image" className="w-4 h-4 mr-2" /> 1. Habitación Vacía
                                    </label>
                                    <div className={`relative border-2 border-dashed rounded-2xl p-4 text-center ${roomPreview ? 'border-indigo-400 bg-indigo-50' : 'border-slate-300'}`}>
                                        {roomPreview ? <img src={roomPreview} className="max-h-40 mx-auto rounded-lg shadow-sm" /> :
                                            <div className="py-6"><Icon name="upload" className="w-8 h-8 text-slate-300 mx-auto mb-2" /><p className="text-xs text-slate-400">Subir habitación</p></div>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => handleImageUpload(e, 'room')} />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-3 flex items-center">
                                        <Icon name="sofa" className="w-4 h-4 mr-2" /> 2. Mueble
                                    </label>
                                    <div className={`relative border-2 border-dashed rounded-2xl p-4 text-center ${furniturePreview ? 'border-indigo-400 bg-indigo-50' : 'border-slate-300'}`}>
                                        {furniturePreview ? <img src={furniturePreview} className="max-h-40 mx-auto rounded-lg shadow-sm" /> :
                                            <div className="py-6"><Icon name="upload" className="w-8 h-8 text-slate-300 mx-auto mb-2" /><p className="text-xs text-slate-400">Subir mueble</p></div>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => handleImageUpload(e, 'furniture')} />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-3">3. Instrucciones</label>
                                    <textarea className="w-full p-4 rounded-2xl border border-slate-100 bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" rows="3" value={prompt} onChange={(e) => setPrompt(e.target.value)} />
                                </div>

                                <button onClick={generateDesign} disabled={loading || !roomFile || !furnitureFile} className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center transition-all ${loading || !roomFile || !furnitureFile ? 'bg-slate-200 text-slate-400' : 'bg-indigo-600 text-white shadow-lg shadow-indigo-100 hover:bg-indigo-700'}`}>
                                    {loading ? <Icon name="loader-2" className="w-5 h-5 animate-spin" /> : <><Icon name="sparkles" className="w-5 h-5 mr-2" /> Generar Diseño</>}
                                </button>

                                {error && <div className="text-red-500 text-xs p-3 bg-red-50 rounded-xl border border-red-100">{error}</div>}
                            </div>

                            <div className="bg-slate-900 rounded-3xl flex flex-col items-center justify-center p-6 min-h-[400px] relative overflow-hidden shadow-xl border border-slate-800">
                                {resultImage ? (
                                    <img src={resultImage} className="max-w-full max-h-full rounded-xl shadow-2xl animate-in fade-in duration-500" />
                                ) : (
                                    <div className="text-center">
                                        <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <Icon name="wand-2" className="w-8 h-8 text-slate-600" />
                                        </div>
                                        <p className="text-slate-500 text-sm">El resultado aparecerá aquí</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>